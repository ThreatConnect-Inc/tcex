

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>tcex.batch.batch &mdash; TcEx 2.0.19 documentation</title>



  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />










  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->


      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>

    <script type="text/javascript" src="../../../_static/js/theme.js"></script>


    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
</head>

<body class="wy-body-for-nav">


  <div class="wy-grid-for-nav">

    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >



            <a href="../../../index.html" class="icon icon-home"> TcEx



          </a>




              <div class="version">
                2.0.19
              </div>




<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div>


        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">






              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../building_apps_quickstart.html">Building Apps: Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../building_apps_tcinit.html">Building Apps: Templates (tcinit)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../building_apps_tclib.html">Building Apps: Dependencies (tclib)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../building_apps_tcpackage.html">Building Apps: Packaging (tcpackage)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../app_deployment_configuration.html">App-Deployment Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../app_directory_structure.html">App-Directory Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_batch.html">Module: Batch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_cache.html">Module: Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_case_management.html">Module: Case Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_datastore.html">Module: Datastore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_decorators.html">Module: Decorators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_metrics.html">Module: Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_notifications.html">Module: Notifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_playbook.html">Module: Playbooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_services.html">Module: Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_threat_intelligence.html">Module: Threat Intelligence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_utils.html">Module: Utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authorization.html">Authorization (Token/HMAC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../exit.html">Exit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../message_tc.html">Message TC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parser.html">Parser/Args</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../proxies.html">Proxies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../results_tc.html">Results TC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tcex_docs/modules.html">TcEx Package</a></li>
</ul>



        </div>

      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">


      <nav class="wy-nav-top" aria-label="top navigation">

          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TcEx</a>

      </nav>


      <div class="wy-nav-content">

        <div class="rst-content">



















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">

      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>

          <li><a href="../../index.html">Module code</a> &raquo;</li>

      <li>tcex.batch.batch</li>


      <li class="wy-breadcrumbs-aside">

      </li>

  </ul>


  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <h1>Source code for tcex.batch.batch</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;ThreatConnect Batch Import Module.&quot;&quot;&quot;</span>
<span class="c1"># standard library</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shelve</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">.group</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Adversary</span><span class="p">,</span>
    <span class="n">Campaign</span><span class="p">,</span>
    <span class="n">Document</span><span class="p">,</span>
    <span class="n">Email</span><span class="p">,</span>
    <span class="n">Event</span><span class="p">,</span>
    <span class="n">Group</span><span class="p">,</span>
    <span class="n">Incident</span><span class="p">,</span>
    <span class="n">IntrusionSet</span><span class="p">,</span>
    <span class="n">Report</span><span class="p">,</span>
    <span class="n">Signature</span><span class="p">,</span>
    <span class="n">Threat</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.indicator</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ASN</span><span class="p">,</span>
    <span class="n">CIDR</span><span class="p">,</span>
    <span class="n">URL</span><span class="p">,</span>
    <span class="n">Address</span><span class="p">,</span>
    <span class="n">EmailAddress</span><span class="p">,</span>
    <span class="n">File</span><span class="p">,</span>
    <span class="n">Host</span><span class="p">,</span>
    <span class="n">Indicator</span><span class="p">,</span>
    <span class="n">Mutex</span><span class="p">,</span>
    <span class="n">RegistryKey</span><span class="p">,</span>
    <span class="n">UserAgent</span><span class="p">,</span>
    <span class="n">custom_indicator_class_factory</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># import local modules for dynamic reference</span>
<span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Batch"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch">[docs]</a><span class="k">class</span> <span class="nc">Batch</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;ThreatConnect Batch Import Module&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tcex</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="n">owner</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">action</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Create&#39;</span><span class="p">,</span>
        <span class="n">attribute_write_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Replace&#39;</span><span class="p">,</span>
        <span class="n">halt_on_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">playbook_triggers_enabled</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize Class properties.</span>

<span class="sd">        Args:</span>
<span class="sd">            tcex: An instance of TcEx object.</span>
<span class="sd">            owner: The ThreatConnect owner for Batch action.</span>
<span class="sd">            action: Action for the batch job [&#39;Create&#39;, &#39;Delete&#39;].</span>
<span class="sd">            attribute_write_type: Write type for Indicator attributes [&#39;Append&#39;, &#39;Replace&#39;].</span>
<span class="sd">            halt_on_error: If True any batch error will halt the batch job.</span>
<span class="sd">            playbook_triggers_enabled: **DEPRECATED**</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span> <span class="o">=</span> <span class="n">tcex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_action</span> <span class="o">=</span> <span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attribute_write_type</span> <span class="o">=</span> <span class="n">attribute_write_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_halt_on_error</span> <span class="o">=</span> <span class="n">halt_on_error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span> <span class="o">=</span> <span class="n">owner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_playbook_triggers_enabled</span> <span class="o">=</span> <span class="n">playbook_triggers_enabled</span>

        <span class="c1"># properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_max_chunk</span> <span class="o">=</span> <span class="mi">5000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_max_size</span> <span class="o">=</span> <span class="mi">75_000_000</span>  <span class="c1"># max size in bytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_merge_mode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_threads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hash_collision_mode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_submit_thread</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># shelf settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_shelf_fqfn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indicator_shelf_fqfn</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># global overrides on batch/file errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_halt_on_batch_error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_halt_on_file_error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_halt_on_poll_error</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># debug/saved flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saved_xids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saved_groups</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># indicates groups shelf file was provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saved_indicators</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># indicates indicators shelf file was provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_saved_file</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># default properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_data_count</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_poll_timeout</span> <span class="o">=</span> <span class="mi">3600</span>

        <span class="c1"># containers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_groups_shelf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indicators</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indicators_shelf</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># build custom indicator classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gen_indicator_class</span><span class="p">()</span>

        <span class="c1"># batch debug/replay variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">tc_temp_path</span><span class="p">,</span> <span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_path_batch</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path</span><span class="p">,</span> <span class="s1">&#39;batch_data&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_path_group_shelf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path</span><span class="p">,</span> <span class="s1">&#39;groups-saved&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_path_indicator_shelf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path</span><span class="p">,</span> <span class="s1">&#39;indicators-saved&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_path_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path</span><span class="p">,</span> <span class="s1">&#39;batch_files&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_path_xids</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path</span><span class="p">,</span> <span class="s1">&#39;xids-saved&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_critical_failures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;Return Batch critical failure messages.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">&#39;Encountered an unexpected Exception while processing batch job&#39;</span><span class="p">,</span>
            <span class="s1">&#39;would exceed the number of allowed indicators&#39;</span><span class="p">,</span>
        <span class="p">]</span>

<div class="viewcode-block" id="Batch._gen_indicator_class"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch._gen_indicator_class">[docs]</a>    <span class="k">def</span> <span class="nf">_gen_indicator_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;Generate Custom Indicator Classes.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">indicator_types_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="c1"># temp fix for API issue where boolean are returned as strings</span>
            <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;custom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_bool</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
                <span class="c1"># skip Indicator Type if a class already exists</span>
                <span class="k">continue</span>

            <span class="c1"># Custom Indicator can have 3 values. Only add the value if it is set.</span>
            <span class="n">value_fields</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value1Label&#39;</span><span class="p">):</span>
                <span class="n">value_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;value1Label&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value2Label&#39;</span><span class="p">):</span>
                <span class="n">value_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;value2Label&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value3Label&#39;</span><span class="p">):</span>
                <span class="n">value_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;value3Label&#39;</span><span class="p">])</span>
            <span class="n">value_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value_fields</span><span class="p">)</span>

            <span class="n">class_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Add Class for each Custom Indicator type to this module</span>
            <span class="n">custom_class</span> <span class="o">=</span> <span class="n">custom_indicator_class_factory</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Indicator</span><span class="p">,</span> <span class="n">class_data</span><span class="p">,</span> <span class="n">value_fields</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">custom_class</span><span class="p">)</span>

            <span class="c1"># Add Custom Indicator Method</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gen_indicator_method</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">custom_class</span><span class="p">,</span> <span class="n">value_count</span><span class="p">)</span></div>

<div class="viewcode-block" id="Batch._gen_indicator_method"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch._gen_indicator_method">[docs]</a>    <span class="k">def</span> <span class="nf">_gen_indicator_method</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">custom_class</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">value_count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;Dynamically generate custom Indicator methods.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): The name of the method.</span>
<span class="sd">            custom_class (object): The class to add.</span>
<span class="sd">            value_count (int): The number of value parameters to support.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">method_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># Add Method for each Custom Indicator class</span>
        <span class="k">def</span> <span class="nf">method_1</span><span class="p">(</span><span class="n">value1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pylint: disable=possibly-unused-variable</span>
            <span class="sd">&quot;&quot;&quot;Add Custom Indicator data to Batch object&quot;&quot;&quot;</span>
            <span class="n">indicator_obj</span> <span class="o">=</span> <span class="n">custom_class</span><span class="p">(</span><span class="n">value1</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="p">(</span><span class="n">indicator_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">method_2</span><span class="p">(</span>
            <span class="n">value1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>  <span class="c1"># pylint: disable=possibly-unused-variable</span>
            <span class="sd">&quot;&quot;&quot;Add Custom Indicator data to Batch object&quot;&quot;&quot;</span>
            <span class="n">indicator_obj</span> <span class="o">=</span> <span class="n">custom_class</span><span class="p">(</span><span class="n">value1</span><span class="p">,</span> <span class="n">value2</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="p">(</span><span class="n">indicator_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">method_3</span><span class="p">(</span>
            <span class="n">value1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value3</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>  <span class="c1"># pylint: disable=possibly-unused-variable</span>
            <span class="sd">&quot;&quot;&quot;Add Custom Indicator data to Batch object&quot;&quot;&quot;</span>
            <span class="n">indicator_obj</span> <span class="o">=</span> <span class="n">custom_class</span><span class="p">(</span><span class="n">value1</span><span class="p">,</span> <span class="n">value2</span><span class="p">,</span> <span class="n">value3</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="p">(</span><span class="n">indicator_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>

        <span class="n">method</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="sa">f</span><span class="s1">&#39;method_</span><span class="si">{</span><span class="n">value_count</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span></div>

<div class="viewcode-block" id="Batch._group"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch._group">[docs]</a>    <span class="k">def</span> <span class="nf">_group</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">group_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span> <span class="n">store</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return previously stored group or new group.</span>

<span class="sd">        Args:</span>
<span class="sd">            group_data: An Group dict or instance of Group object.</span>
<span class="sd">            store: If True the group data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[dict, object]: The new Group dict/object or the previously stored dict/object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">store</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">group_data</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># get xid from dict</span>
            <span class="n">xid</span> <span class="o">=</span> <span class="n">group_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xid&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get xid from object</span>
            <span class="n">xid</span> <span class="o">=</span> <span class="n">group_data</span><span class="o">.</span><span class="n">xid</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># return existing group from memory</span>
            <span class="n">group_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_shelf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># return existing group from shelf</span>
            <span class="n">group_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_shelf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># store new group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">xid</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_data</span>
        <span class="k">return</span> <span class="n">group_data</span></div>

<div class="viewcode-block" id="Batch._indicator"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch._indicator">[docs]</a>    <span class="k">def</span> <span class="nf">_indicator</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">indicator_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span> <span class="n">store</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return previously stored indicator or new indicator.</span>

<span class="sd">        Args:</span>
<span class="sd">            indicator_data: An Indicator dict or instance of Indicator object.</span>
<span class="sd">            store: If True the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[dict, object]: The new Indicator dict/object or the previously stored dict/object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">store</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">indicator_data</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indicator_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># get xid from dict</span>
            <span class="n">xid</span> <span class="o">=</span> <span class="n">indicator_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xid&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get xid from object</span>
            <span class="n">xid</span> <span class="o">=</span> <span class="n">indicator_data</span><span class="o">.</span><span class="n">xid</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># return existing indicator from memory</span>
            <span class="n">indicator_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators_shelf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># return existing indicator from shelf</span>
            <span class="n">indicator_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators_shelf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># store new indicators</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">[</span><span class="n">xid</span><span class="p">]</span> <span class="o">=</span> <span class="n">indicator_data</span>
        <span class="k">return</span> <span class="n">indicator_data</span></div>

<div class="viewcode-block" id="Batch._indicator_values"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch._indicator_values">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_indicator_values</span><span class="p">(</span><span class="n">indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Process indicators expanding file hashes/custom indicators into multiple entries.</span>

<span class="sd">        Args:</span>
<span class="sd">            indicator: Indicator value represented as &quot; : &quot; delimited string.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: The list of indicators split on &quot; : &quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indicator_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">indicator</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">indicator</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39; : &#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># handle all multi-valued indicators types (file hashes and custom indicators)</span>
            <span class="n">indicator_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># group 1 - lazy capture everything to first &lt;space&gt;:&lt;space&gt; or end of line</span>
            <span class="n">iregx_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^(.*?(?=\s\:\s|$))?&#39;</span>
            <span class="n">iregx_pattern</span> <span class="o">+=</span> <span class="sa">r</span><span class="s1">&#39;(?:\s\:\s)?&#39;</span>  <span class="c1"># remove &lt;space&gt;:&lt;space&gt;</span>
            <span class="c1"># group 2 - look behind for &lt;space&gt;:&lt;space&gt;, lazy capture everything</span>
            <span class="c1">#           to look ahead (optional &lt;space&gt;):&lt;space&gt; or end of line</span>
            <span class="n">iregx_pattern</span> <span class="o">+=</span> <span class="sa">r</span><span class="s1">&#39;((?&lt;=\s\:\s).*?(?=(?:\s)?\:\s|$))?&#39;</span>
            <span class="n">iregx_pattern</span> <span class="o">+=</span> <span class="sa">r</span><span class="s1">&#39;(?:(?:\s)?\:\s)?&#39;</span>  <span class="c1"># remove (optional &lt;space&gt;):&lt;space&gt;</span>
            <span class="c1"># group 3 - look behind for &lt;space&gt;:&lt;space&gt;, lazy capture everything</span>
            <span class="c1">#           to look ahead end of line</span>
            <span class="n">iregx_pattern</span> <span class="o">+=</span> <span class="sa">r</span><span class="s1">&#39;((?&lt;=\s\:\s).*?(?=$))?$&#39;</span>
            <span class="n">iregx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">iregx_pattern</span><span class="p">)</span>

            <span class="n">indicators</span> <span class="o">=</span> <span class="n">iregx</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">indicator</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">indicators</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">indicator_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">indicators</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">indicator_list</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return batch action.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action</span>

    <span class="nd">@action</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set batch action.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_action</span> <span class="o">=</span> <span class="n">action</span>

<div class="viewcode-block" id="Batch.add_group"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.add_group">[docs]</a>    <span class="k">def</span> <span class="nf">add_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Add a group to Batch Job.</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            {</span>
<span class="sd">                &quot;name&quot;: &quot;Example Incident&quot;,</span>
<span class="sd">                &quot;type&quot;: &quot;Incident&quot;,</span>
<span class="sd">                &quot;attribute&quot;: [{</span>
<span class="sd">                    &quot;type&quot;: &quot;Description&quot;,</span>
<span class="sd">                    &quot;displayed&quot;: false,</span>
<span class="sd">                    &quot;value&quot;: &quot;Example Description&quot;</span>
<span class="sd">                }],</span>
<span class="sd">                &quot;xid&quot;: &quot;e336e2dd-5dfb-48cd-a33a-f8809e83e904&quot;,</span>
<span class="sd">                &quot;associatedGroupXid&quot;: [</span>
<span class="sd">                    &quot;e336e2dd-5dfb-48cd-a33a-f8809e83e904:58&quot;,</span>
<span class="sd">                ],</span>
<span class="sd">                &quot;tag&quot;: [{</span>
<span class="sd">                    &quot;name&quot;: &quot;China&quot;</span>
<span class="sd">                }]</span>
<span class="sd">            }</span>

<span class="sd">        Args:</span>
<span class="sd">            group_data: The full Group data including attributes, labels, tags, and</span>
<span class="sd">                associations.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[dict, object]: The new group dict/object or the previously stored dict/object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">(</span><span class="n">group_data</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.add_indicator"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.add_indicator">[docs]</a>    <span class="k">def</span> <span class="nf">add_indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indicator_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Add an indicator to Batch Job.</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            {</span>
<span class="sd">                &quot;type&quot;: &quot;File&quot;,</span>
<span class="sd">                &quot;rating&quot;: 5.00,</span>
<span class="sd">                &quot;confidence&quot;: 50,</span>
<span class="sd">                &quot;summary&quot;: &quot;53c3609411c83f363e051d455ade78a7</span>
<span class="sd">                            : 57a49b478310e4313c54c0fee46e4d70a73dd580</span>
<span class="sd">                            : db31cb2a748b7e0046d8c97a32a7eb4efde32a0593e5dbd58e07a3b4ae6bf3d7&quot;,</span>
<span class="sd">                &quot;associatedGroups&quot;: [</span>
<span class="sd">                    {</span>
<span class="sd">                        &quot;groupXid&quot;: &quot;e336e2dd-5dfb-48cd-a33a-f8809e83e904&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                ],</span>
<span class="sd">                &quot;attribute&quot;: [{</span>
<span class="sd">                    &quot;type&quot;: &quot;Source&quot;,</span>
<span class="sd">                    &quot;displayed&quot;: true,</span>
<span class="sd">                    &quot;value&quot;: &quot;Malware Analysis provided by external AMA.&quot;</span>
<span class="sd">                }],</span>
<span class="sd">                &quot;fileOccurrence&quot;: [{</span>
<span class="sd">                    &quot;fileName&quot;: &quot;drop1.exe&quot;,</span>
<span class="sd">                    &quot;date&quot;: &quot;2017-03-03T18:00:00-06:00&quot;</span>
<span class="sd">                }],</span>
<span class="sd">                &quot;tag&quot;: [{</span>
<span class="sd">                    &quot;name&quot;: &quot;China&quot;</span>
<span class="sd">                }],</span>
<span class="sd">                &quot;xid&quot;: &quot;e336e2dd-5dfb-48cd-a33a-f8809e83e904:170139&quot;</span>
<span class="sd">            }</span>

<span class="sd">        Args:</span>
<span class="sd">            indicator_data: The Full Indicator data including attributes, labels, tags,</span>
<span class="sd">                and associations.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[dict, object]: The new group dict/object or the previously stored dict/object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">indicator_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Address&#39;</span><span class="p">,</span> <span class="s1">&#39;EmailAddress&#39;</span><span class="p">,</span> <span class="s1">&#39;File&#39;</span><span class="p">,</span> <span class="s1">&#39;Host&#39;</span><span class="p">,</span> <span class="s1">&#39;URL&#39;</span><span class="p">]:</span>
            <span class="c1"># for custom indicator types the valueX fields are required.</span>
            <span class="c1"># using the summary we can build the values</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator_values</span><span class="p">(</span><span class="n">indicator_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">)):</span>
                <span class="n">indicator_data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;value</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">indicator_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;File&#39;</span><span class="p">:</span>
            <span class="c1"># convert custom field name to the appropriate value for batch v2</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">indicator_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">indicator_data</span><span class="p">[</span><span class="s1">&#39;intValue1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span>
        <span class="k">if</span> <span class="n">indicator_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Host&#39;</span><span class="p">:</span>
            <span class="c1"># convert custom field name to the appropriate value for batch v2</span>
            <span class="n">dns_active</span> <span class="o">=</span> <span class="n">indicator_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dnsActive&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dns_active</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">indicator_data</span><span class="p">[</span><span class="s1">&#39;flag1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dns_active</span>
            <span class="n">whois_active</span> <span class="o">=</span> <span class="n">indicator_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;whoisActive&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">whois_active</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">indicator_data</span><span class="p">[</span><span class="s1">&#39;flag2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">whois_active</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="p">(</span><span class="n">indicator_data</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.address"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.address">[docs]</a>    <span class="k">def</span> <span class="nf">address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Address</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Address data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            ip: The value for this Indicator.</span>
<span class="sd">            confidence (str, kwargs): The threat confidence for this Indicator.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            last_modified (str, kwargs): The date timestamp the Indicator was last modified.</span>
<span class="sd">            rating (str, kwargs): The threat rating for this Indicator.</span>
<span class="sd">            xid (str, kwargs): The external id for this Indicator.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Address: An instance of the Address class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indicator_obj</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="p">(</span><span class="n">indicator_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.adversary"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.adversary">[docs]</a>    <span class="k">def</span> <span class="nf">adversary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Adversary</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Adversary data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name for this Group.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            xid (str, kwargs): The external id for this Group.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Adversary: An instance of the Adversary class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_obj</span> <span class="o">=</span> <span class="n">Adversary</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">(</span><span class="n">group_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.asn"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.asn">[docs]</a>    <span class="k">def</span> <span class="nf">asn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ASN</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add ASN data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            as_number: The value for this Indicator.</span>
<span class="sd">            confidence (str, kwargs): The threat confidence for this Indicator.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            last_modified (str, kwargs): The date timestamp the Indicator was last modified.</span>
<span class="sd">            rating (str, kwargs): The threat rating for this Indicator.</span>
<span class="sd">            xid (str, kwargs): The external id for this Indicator.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ASN: An instance of the ASN class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indicator_obj</span> <span class="o">=</span> <span class="n">ASN</span><span class="p">(</span><span class="n">as_number</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="p">(</span><span class="n">indicator_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">attribute_write_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return batch attribute write type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attribute_write_type</span>

    <span class="nd">@attribute_write_type</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">attribute_write_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute_write_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set batch attribute write type.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attribute_write_type</span> <span class="o">=</span> <span class="n">attribute_write_type</span>

<div class="viewcode-block" id="Batch.campaign"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.campaign">[docs]</a>    <span class="k">def</span> <span class="nf">campaign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Campaign</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Campaign data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name for this Group.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            first_seen (str, kwargs): The first seen datetime expression for this Group.</span>
<span class="sd">            xid (str, kwargs): The external id for this Group.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Campaign: An instance of the Campaign class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_obj</span> <span class="o">=</span> <span class="n">Campaign</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">(</span><span class="n">group_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.cidr"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.cidr">[docs]</a>    <span class="k">def</span> <span class="nf">cidr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CIDR</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add CIDR data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            block: The value for this Indicator.</span>
<span class="sd">            confidence (str, kwargs): The threat confidence for this Indicator.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            last_modified (str, kwargs): The date timestamp the Indicator was last modified.</span>
<span class="sd">            rating (str, kwargs): The threat rating for this Indicator.</span>
<span class="sd">            xid (str, kwargs): The external id for this Indicator.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            CIDR: An instance of the CIDR class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indicator_obj</span> <span class="o">=</span> <span class="n">CIDR</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="p">(</span><span class="n">indicator_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.close"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cleanup batch job.&quot;&quot;&quot;</span>
        <span class="c1"># allow pol thread to complete before wrapping up</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_submit_thread</span><span class="p">,</span> <span class="s1">&#39;is_alive&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_submit_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c1"># allow file threads to complete before wrapping up job</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_threads</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">groups_shelf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicators_shelf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_saved_file</span><span class="p">:</span>
            <span class="c1"># delete saved files</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_shelf_fqfn</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_shelf_fqfn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_shelf_fqfn</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indicator_shelf_fqfn</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the batch indicator/group and file data to be sent to the ThreatConnect API.</span>

<span class="sd">        **Processing Order:**</span>
<span class="sd">        * Process groups in memory up to max batch size.</span>
<span class="sd">        * Process groups in shelf to max batch size.</span>
<span class="sd">        * Process indicators in memory up to max batch size.</span>
<span class="sd">        * Process indicators in shelf up to max batch size.</span>

<span class="sd">        This method will remove the group/indicator from memory and/or shelf.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary of group, indicators, and/or file data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;indicator&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">tracker</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;bytes&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="c1"># process group from memory, returning if max values have been reached</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_groups</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span> <span class="n">tracker</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="c1"># process group from shelf file, returning if max values have been reached</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_groups</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_shelf</span><span class="p">,</span> <span class="n">tracker</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="c1"># process indicator from memory, returning if max values have been reached</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_indicators</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">,</span> <span class="n">tracker</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="c1"># process indicator from shelf file, returning if max values have been reached</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_indicators</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators_shelf</span><span class="p">,</span> <span class="n">tracker</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="k">return</span> <span class="n">data</span>

<div class="viewcode-block" id="Batch.data_group_association"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.data_group_association">[docs]</a>    <span class="k">def</span> <span class="nf">data_group_association</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">tracker</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">xid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return group dict array following all associations.</span>

<span class="sd">        The *data* dict is passed by reference to make it easier to update both the group data</span>
<span class="sd">        and file data inline versus passing the data all the way back up to the calling methods.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The data dict to update with group and file data.</span>
<span class="sd">            tracker: A dict containing total count of all entities collected and</span>
<span class="sd">                the total size in bytes of all entities collected.</span>
<span class="sd">            xid: The xid of the group to retrieve associations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xids</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="n">xids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">xids</span><span class="p">:</span>
            <span class="n">xid</span> <span class="o">=</span> <span class="n">xids</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>  <span class="c1"># remove current xid</span>
            <span class="n">group_data</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">xid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="n">group_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">xid</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">xid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_shelf</span><span class="p">:</span>
                <span class="n">group_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_shelf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_shelf</span><span class="p">[</span><span class="n">xid</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">group_data</span><span class="p">:</span>
                <span class="n">file_data</span><span class="p">,</span> <span class="n">group_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_group_type</span><span class="p">(</span><span class="n">group_data</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">file_data</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">][</span><span class="n">xid</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_data</span>

                <span class="c1"># update entity trackers</span>
                <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;bytes&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">group_data</span><span class="p">))</span>

                <span class="c1"># extend xids with any groups associated with the same object</span>
                <span class="n">xids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">group_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;associatedGroupXid&#39;</span><span class="p">,</span> <span class="p">[]))</span></div>

<div class="viewcode-block" id="Batch.data_group_type"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.data_group_type">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">data_group_type</span><span class="p">(</span><span class="n">group_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return dict representation of group data and file data.</span>

<span class="sd">        Args:</span>
<span class="sd">            group_data: The group data dict or object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[dict, dict]: A tuple containing file_data and group_data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># process file content</span>
            <span class="n">file_content</span> <span class="o">=</span> <span class="n">group_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fileContent&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">file_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;fileContent&#39;</span><span class="p">:</span> <span class="n">file_content</span><span class="p">,</span>
                    <span class="s1">&#39;fileName&#39;</span><span class="p">:</span> <span class="n">group_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fileName&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">group_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">),</span>
                <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get the file data from the object and return dict format of object</span>
            <span class="k">if</span> <span class="n">group_data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Document&#39;</span><span class="p">,</span> <span class="s1">&#39;Report&#39;</span><span class="p">]:</span>
                <span class="n">file_data</span> <span class="o">=</span> <span class="n">group_data</span><span class="o">.</span><span class="n">file_data</span>
            <span class="n">group_data</span> <span class="o">=</span> <span class="n">group_data</span><span class="o">.</span><span class="n">data</span>

        <span class="k">return</span> <span class="n">file_data</span><span class="p">,</span> <span class="n">group_data</span></div>

<div class="viewcode-block" id="Batch.data_groups"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.data_groups">[docs]</a>    <span class="k">def</span> <span class="nf">data_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">groups</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">tracker</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Process Group data.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The data dict to update with group and file data.</span>
<span class="sd">            groups: The list of groups to process.</span>
<span class="sd">            tracker: A dict containing total count of all entities collected and</span>
<span class="sd">                the total size in bytes of all entities collected.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if max values have been hit, else False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># convert groups.keys() to a list to prevent dictionary change error caused by</span>
        <span class="c1"># the data_group_association function deleting items from the object.</span>

        <span class="c1"># process group objects</span>
        <span class="k">for</span> <span class="n">xid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="c1"># get association from group data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_group_association</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">tracker</span><span class="p">,</span> <span class="n">xid</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">tracker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2_500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># log count/size at a sane level</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sd">&#39;&#39;&#39;feature=batch, action=data-groups, &#39;&#39;&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;&#39;&#39;count=</span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">, bytes=</span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bytes&#39;</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;&#39;&#39;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">tracker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_max_chunk</span>
                <span class="ow">or</span> <span class="n">tracker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bytes&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_max_size</span>
            <span class="p">):</span>
                <span class="c1"># stop processing xid once max limit are reached</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sd">&#39;&#39;&#39;feature=batch, event=max-value-reached, &#39;&#39;&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;&#39;&#39;count=</span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">, bytes=</span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bytes&#39;</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;&#39;&#39;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Batch.data_indicators"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.data_indicators">[docs]</a>    <span class="k">def</span> <span class="nf">data_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">indicators</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">tracker</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Process Indicator data.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The data dict to update with group and file data.</span>
<span class="sd">            indicators: The list of indicators to process.</span>
<span class="sd">            tracker: A dict containing total count of all entities collected and</span>
<span class="sd">                the total size in bytes of all entities collected.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if max values have been hit, else False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># process indicator objects</span>
        <span class="k">for</span> <span class="n">xid</span><span class="p">,</span> <span class="n">indicator_data</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">indicators</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indicator_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">indicator_data</span> <span class="o">=</span> <span class="n">indicator_data</span><span class="o">.</span><span class="n">data</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;indicator&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indicator_data</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">indicators</span><span class="p">[</span><span class="n">xid</span><span class="p">]</span>

            <span class="c1"># update entity trackers</span>
            <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;bytes&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">indicator_data</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">tracker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2_500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># log count/size at a sane level</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sd">&#39;&#39;&#39;feature=batch, action=data-indicators, &#39;&#39;&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;&#39;&#39;count=</span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">, bytes=</span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bytes&#39;</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;&#39;&#39;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">tracker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_max_chunk</span>
                <span class="ow">or</span> <span class="n">tracker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bytes&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_max_size</span>
            <span class="p">):</span>
                <span class="c1"># stop processing xid once max limit are reached</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sd">&#39;&#39;&#39;feature=batch, event=max-value-reached, &#39;&#39;&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;&#39;&#39;count=</span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">, bytes=</span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bytes&#39;</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;&#39;&#39;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return debug setting&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># switching DEBUG file to a directory</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
                <span class="c1"># create directories only required when debug is enabled</span>
                <span class="c1"># batch_json - store the batch*.json files</span>
                <span class="c1"># documents - store the file downloads (e.g., *.pdf)</span>
                <span class="c1"># reports - store the file downloads (e.g., *.pdf)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path_batch</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path_files</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span>

<div class="viewcode-block" id="Batch.document"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.document">[docs]</a>    <span class="k">def</span> <span class="nf">document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Document</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Document data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name for this Group.</span>
<span class="sd">            file_name: The name for the attached file for this Group.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            file_content (str;method, kwargs): The file contents or</span>
<span class="sd">                callback method to retrieve file content.</span>
<span class="sd">            malware (bool, kwargs): If true the file is considered malware.</span>
<span class="sd">            password (bool, kwargs): If malware is true a password for the zip archive is</span>
<span class="sd">            xid (str, kwargs): The external id for this Group.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Document: An instance of the Document class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_obj</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">(</span><span class="n">group_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.email"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.email">[docs]</a>    <span class="k">def</span> <span class="nf">email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subject</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">header</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Email</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Email data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name for this Group.</span>
<span class="sd">            subject: The subject for this Email.</span>
<span class="sd">            header: The header for this Email.</span>
<span class="sd">            body: The body for this Email.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            from_addr (str, kwargs): The **from** address for this Email.</span>
<span class="sd">            to_addr (str, kwargs): The **to** address for this Email.</span>
<span class="sd">            xid (str, kwargs): The external id for this Group.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Email: An instance of the Email class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_obj</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">(</span><span class="n">group_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.email_address"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.email_address">[docs]</a>    <span class="k">def</span> <span class="nf">email_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EmailAddress</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Email Address data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            address: The value for this Indicator.</span>
<span class="sd">            confidence (str, kwargs): The threat confidence for this Indicator.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            last_modified (str, kwargs): The date timestamp the Indicator was last modified.</span>
<span class="sd">            rating (str, kwargs): The threat rating for this Indicator.</span>
<span class="sd">            xid (str, kwargs): The external id for this Indicator.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            EmailAddress: An instance of the EmailAddress class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indicator_obj</span> <span class="o">=</span> <span class="n">EmailAddress</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="p">(</span><span class="n">indicator_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">error_codes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return static list of Batch error codes and short description&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;0x1001&#39;</span><span class="p">:</span> <span class="s1">&#39;General Error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;0x1002&#39;</span><span class="p">:</span> <span class="s1">&#39;Permission Error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;0x1003&#39;</span><span class="p">:</span> <span class="s1">&#39;JsonSyntax Error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;0x1004&#39;</span><span class="p">:</span> <span class="s1">&#39;Internal Error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;0x1005&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid Indicator Error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;0x1006&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid Group Error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;0x1007&#39;</span><span class="p">:</span> <span class="s1">&#39;Item Not Found Error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;0x1008&#39;</span><span class="p">:</span> <span class="s1">&#39;Indicator Limit Error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;0x1009&#39;</span><span class="p">:</span> <span class="s1">&#39;Association Error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;0x100A&#39;</span><span class="p">:</span> <span class="s1">&#39;Duplicate Item Error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;0x100B&#39;</span><span class="p">:</span> <span class="s1">&#39;File IO Error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;0x2001&#39;</span><span class="p">:</span> <span class="s1">&#39;Indicator Partial Loss Error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;0x2002&#39;</span><span class="p">:</span> <span class="s1">&#39;Group Partial Loss Error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;0x2003&#39;</span><span class="p">:</span> <span class="s1">&#39;File Hash Merge Error&#39;</span><span class="p">,</span>
        <span class="p">}</span>

<div class="viewcode-block" id="Batch.errors"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.errors">[docs]</a>    <span class="k">def</span> <span class="nf">errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve Batch errors to ThreatConnect API.</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            [{</span>
<span class="sd">                &quot;errorReason&quot;: &quot;Incident incident-001 has an invalid status.&quot;,</span>
<span class="sd">                &quot;errorSource&quot;: &quot;incident-001 is not valid.&quot;</span>
<span class="sd">            }, {</span>
<span class="sd">                &quot;errorReason&quot;: &quot;Incident incident-002 has an invalid status.&quot;,</span>
<span class="sd">                &quot;errorSource&quot;:&quot;incident-002 is not valid.&quot;</span>
<span class="sd">            }]</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_id: The ID returned from the ThreatConnect API for the current batch job.</span>
<span class="sd">            halt_on_error: If True any exception will raise an error.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of batch errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;feature=batch, event=retrieve-errors, batch-id=</span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/v2/batch/</span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s1">/errors&#39;</span><span class="p">)</span>
            <span class="c1"># API does not return correct content type</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="c1"># temporarily process errors to find &quot;critical&quot; errors.</span>
            <span class="c1"># FR in core to return error codes.</span>
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">error_reason</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errorReason&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">error_msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_critical_failures</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">error_reason</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="mi">10500</span><span class="p">,</span> <span class="p">[</span><span class="n">error_reason</span><span class="p">],</span> <span class="n">halt_on_error</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">errors</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="mi">560</span><span class="p">,</span> <span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">halt_on_error</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Batch.event"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.event">[docs]</a>    <span class="k">def</span> <span class="nf">event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Event</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Event data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name for this Group.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            event_date (str, kwargs): The event datetime expression for this Group.</span>
<span class="sd">            status (str, kwargs): The status for this Group.</span>
<span class="sd">            xid (str, kwargs): The external id for this Group.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Event: An instance of the Event class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_obj</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">(</span><span class="n">group_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.file"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.file">[docs]</a>    <span class="k">def</span> <span class="nf">file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">md5</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sha1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sha256</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">File</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add File data to Batch object.</span>

<span class="sd">        .. note:: A least one file hash value must be specified.</span>

<span class="sd">        Args:</span>
<span class="sd">            md5: The md5 value for this Indicator.</span>
<span class="sd">            sha1: The sha1 value for this Indicator.</span>
<span class="sd">            sha256: The sha256 value for this Indicator.</span>
<span class="sd">            confidence (str, kwargs): The threat confidence for this Indicator.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            last_modified (str, kwargs): The date timestamp the Indicator was last modified.</span>
<span class="sd">            rating (str, kwargs): The threat rating for this Indicator.</span>
<span class="sd">            size (str, kwargs): The file size for this Indicator.</span>
<span class="sd">            xid (str, kwargs): The external id for this Indicator.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            File: An instance of the File class.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indicator_obj</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">md5</span><span class="p">,</span> <span class="n">sha1</span><span class="p">,</span> <span class="n">sha256</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="p">(</span><span class="n">indicator_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.file_merge_mode"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.file_merge_mode">[docs]</a>    <span class="k">def</span> <span class="nf">file_merge_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the file merge mode for the entire batch job.</span>

<span class="sd">        Args:</span>
<span class="sd">            value: A value of Distribute or Merge.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_merge_mode</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="Batch.generate_xid"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.generate_xid">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">generate_xid</span><span class="p">(</span><span class="n">identifier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate xid from provided identifiers.</span>

<span class="sd">        .. Important::  If no identifier is provided a unique xid will be returned, but it will</span>
<span class="sd">                        not be reproducible. If a list of identifiers are provided they must be</span>
<span class="sd">                        in the same order to generate a reproducible xid.</span>

<span class="sd">        Args:</span>
<span class="sd">            identifier:  Optional *string* value(s) to be</span>
<span class="sd">               used to make a unique and reproducible xid.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">identifier</span><span class="p">])</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">identifier</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">identifier</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>

<div class="viewcode-block" id="Batch.group"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.group">[docs]</a>    <span class="k">def</span> <span class="nf">group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Group data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            group_type: The ThreatConnect define Group type.</span>
<span class="sd">            name: The name for this Group.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            xid (str, kwargs): The external id for this Group.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            object: An instance of one of the Group classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_obj</span> <span class="o">=</span> <span class="n">Group</span><span class="p">(</span><span class="n">group_type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">(</span><span class="n">group_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">group_shelf_fqfn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return groups shelf fully qualified filename.</span>

<span class="sd">        For testing/debugging a previous shelf file can be copied into the tc_temp_path directory</span>
<span class="sd">        instead of creating a new shelf file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_shelf_fqfn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># new shelf file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group_shelf_fqfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">tc_temp_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;groups-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

            <span class="c1"># saved shelf file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_groups</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_group_shelf_fqfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_path_group_shelf</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_shelf_fqfn</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">groups</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return dictionary of all Groups data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># plain dict, but could be something else in future</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">groups_shelf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return dictionary of all Groups data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups_shelf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_groups_shelf</span> <span class="o">=</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_shelf_fqfn</span><span class="p">,</span> <span class="n">writeback</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups_shelf</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">halt_on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return batch halt on error setting.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_halt_on_error</span>

    <span class="nd">@halt_on_error</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">halt_on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set batch halt on error setting.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_halt_on_error</span> <span class="o">=</span> <span class="n">halt_on_error</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">halt_on_batch_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return halt on batch error value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_halt_on_batch_error</span>

    <span class="nd">@halt_on_batch_error</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">halt_on_batch_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set batch halt on batch error value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_halt_on_batch_error</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">halt_on_file_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return halt on file post error value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_halt_on_file_error</span>

    <span class="nd">@halt_on_file_error</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">halt_on_file_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set halt on file post error value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_halt_on_file_error</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">halt_on_poll_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return halt on poll error value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_halt_on_poll_error</span>

    <span class="nd">@halt_on_poll_error</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">halt_on_poll_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set batch halt on poll error value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_halt_on_poll_error</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="Batch.hash_collision_mode"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.hash_collision_mode">[docs]</a>    <span class="k">def</span> <span class="nf">hash_collision_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the file hash collision mode for the entire batch job.</span>

<span class="sd">        Args:</span>
<span class="sd">            value: A value of Split, IgnoreIncoming, IgnoreExisting, FavorIncoming,</span>
<span class="sd">                and FavorExisting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hash_collision_mode</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="Batch.host"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.host">[docs]</a>    <span class="k">def</span> <span class="nf">host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Host</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Host data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            hostname: The value for this Indicator.</span>
<span class="sd">            confidence (str, kwargs): The threat confidence for this Indicator.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            dns_active (bool, kwargs): If True DNS active is enabled for this indicator.</span>
<span class="sd">            last_modified (str, kwargs): The date timestamp the Indicator was last modified.</span>
<span class="sd">            rating (str, kwargs): The threat rating for this Indicator.</span>
<span class="sd">            whois_active (bool, kwargs): If True WhoIs active is enabled for this indicator.</span>
<span class="sd">            xid (str, kwargs): The external id for this Indicator.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Host: An instance of the Host class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indicator_obj</span> <span class="o">=</span> <span class="n">Host</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="p">(</span><span class="n">indicator_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.incident"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.incident">[docs]</a>    <span class="k">def</span> <span class="nf">incident</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Incident</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Incident data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name for this Group.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            event_date (str, kwargs): The event datetime expression for this Group.</span>
<span class="sd">            status (str, kwargs): The status for this Group.</span>
<span class="sd">            xid (str, kwargs): The external id for this Group.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Incident: An instance of the Incident class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_obj</span> <span class="o">=</span> <span class="n">Incident</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">(</span><span class="n">group_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.indicator"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.indicator">[docs]</a>    <span class="k">def</span> <span class="nf">indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indicator_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Indicator data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            indicator_type: The ThreatConnect define Indicator type.</span>
<span class="sd">            summary: The value for this Indicator.</span>
<span class="sd">            confidence (str, kwargs): The threat confidence for this Indicator.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            last_modified (str, kwargs): The date timestamp the Indicator was last modified.</span>
<span class="sd">            rating (str, kwargs): The threat rating for this Indicator.</span>
<span class="sd">            xid (str, kwargs): The external id for this Indicator.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            object: An instance of one of the Indicator classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indicator_obj</span> <span class="o">=</span> <span class="n">Indicator</span><span class="p">(</span><span class="n">indicator_type</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="p">(</span><span class="n">indicator_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">indicator_shelf_fqfn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return indicator shelf fully qualified filename.</span>

<span class="sd">        For testing/debugging a previous shelf file can be copied into the tc_temp_path directory</span>
<span class="sd">        instead of creating a new shelf file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator_shelf_fqfn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># new shelf file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indicator_shelf_fqfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">tc_temp_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;indicators-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

            <span class="c1"># saved shelf file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_indicators</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_indicator_shelf_fqfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_path_indicator_shelf</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator_shelf_fqfn</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return dictionary of all Indicator data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># plain dict, but could be something else in future</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indicators</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicators</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">indicators_shelf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return dictionary of all Indicator data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicators_shelf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indicators_shelf</span> <span class="o">=</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indicator_shelf_fqfn</span><span class="p">,</span> <span class="n">writeback</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicators_shelf</span>

<div class="viewcode-block" id="Batch.intrusion_set"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.intrusion_set">[docs]</a>    <span class="k">def</span> <span class="nf">intrusion_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntrusionSet</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Intrusion Set data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name for this Group.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            xid (str, kwargs): The external id for this Group.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            IntrusionSet: An instance of the IntrusionSet class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_obj</span> <span class="o">=</span> <span class="n">IntrusionSet</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">(</span><span class="n">group_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.mutex"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.mutex">[docs]</a>    <span class="k">def</span> <span class="nf">mutex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mutex</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mutex</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Mutex data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            mutex: The value for this Indicator.</span>
<span class="sd">            confidence (str, kwargs): The threat confidence for this Indicator.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            last_modified (str, kwargs): The date timestamp the Indicator was last modified.</span>
<span class="sd">            rating (str, kwargs): The threat rating for this Indicator.</span>
<span class="sd">            xid (str, kwargs): The external id for this Indicator.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Mutex: An instance of the Mutex class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indicator_obj</span> <span class="o">=</span> <span class="n">Mutex</span><span class="p">(</span><span class="n">mutex</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="p">(</span><span class="n">indicator_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.poll"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.poll">[docs]</a>    <span class="k">def</span> <span class="nf">poll</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">batch_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">retry_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">back_off</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">halt_on_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Poll Batch status to ThreatConnect API.</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            {</span>
<span class="sd">                &quot;status&quot;: &quot;Success&quot;,</span>
<span class="sd">                &quot;data&quot;: {</span>
<span class="sd">                    &quot;batchStatus&quot;: {</span>
<span class="sd">                        &quot;id&quot;:3505,</span>
<span class="sd">                        &quot;status&quot;:&quot;Completed&quot;,</span>
<span class="sd">                        &quot;errorCount&quot;:0,</span>
<span class="sd">                        &quot;successCount&quot;:0,</span>
<span class="sd">                        &quot;unprocessCount&quot;:0</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            }</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_id: The ID returned from the ThreatConnect API for the current batch job.</span>
<span class="sd">            retry_seconds: The base number of seconds used for retries when job is not completed.</span>
<span class="sd">            back_off: A multiplier to use for backing off on</span>
<span class="sd">                each poll attempt when job has not completed.</span>
<span class="sd">            timeout: The number of seconds before the poll should timeout.</span>
<span class="sd">            halt_on_error: If True any exception will raise an error.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The batch status returned from the ThreatConnect API.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check global setting for override</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">halt_on_poll_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">halt_on_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halt_on_poll_error</span>

        <span class="c1"># initial poll interval</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_data_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># calculate poll_interval base off the number of entries in the batch data</span>
            <span class="c1"># with a minimum value of 5 seconds.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_data_count</span> <span class="o">/</span> <span class="mi">300</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if not able to calculate poll_interval default to 15 seconds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval</span> <span class="o">=</span> <span class="mi">15</span>

        <span class="c1"># poll retry back_off factor</span>
        <span class="n">poll_interval_back_off</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mf">2.5</span> <span class="k">if</span> <span class="n">back_off</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">back_off</span><span class="p">)</span>

        <span class="c1"># poll retry seconds</span>
        <span class="n">poll_retry_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">5</span> <span class="k">if</span> <span class="n">retry_seconds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">retry_seconds</span><span class="p">)</span>

        <span class="c1"># poll timeout</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poll_timeout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;includeAdditional&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">}</span>

        <span class="n">poll_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">poll_time_total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">poll_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">poll_time_total</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;feature=batch, event=progress, poll-time=</span><span class="si">{</span><span class="n">poll_time_total</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># retrieve job status</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/v2/batch/</span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span> <span class="ow">or</span> <span class="s1">&#39;application/json&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="mi">545</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">],</span> <span class="n">halt_on_error</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">data</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;Success&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="mi">545</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">],</span> <span class="n">halt_on_error</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="mi">540</span><span class="p">,</span> <span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">halt_on_error</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batchStatus&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Completed&#39;</span><span class="p">:</span>
                <span class="c1"># store last 5 poll times to use in calculating average poll time</span>
                <span class="n">modifier</span> <span class="o">=</span> <span class="n">poll_time_total</span> <span class="o">*</span> <span class="mf">0.7</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval_times</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">modifier</span><span class="p">]</span>

                <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">poll_interval_time_weighted_sum</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">poll_interval_time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval_times</span><span class="p">:</span>
                    <span class="n">poll_interval_time_weighted_sum</span> <span class="o">+=</span> <span class="n">poll_interval_time</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># weights will be [1, 1.5, 2.25, 3.375, 5.0625] for all 5 poll times depending</span>
                    <span class="c1"># on how many poll times are available.</span>
                    <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span>

                <span class="c1"># pop off the last weight so its not added in to the sum</span>
                <span class="n">weights</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

                <span class="c1"># calculate the weighted average of the last 5 poll times</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">poll_interval_time_weighted_sum</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">poll_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># if completed on first poll, reduce poll interval.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval</span> <span class="o">*</span> <span class="mf">0.85</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;feature=batch, poll-time=</span><span class="si">{</span><span class="n">poll_time_total</span><span class="si">}</span><span class="s1">, status=</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>

            <span class="c1"># update poll_interval for retry with max poll time of 20 seconds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_poll_interval</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="n">poll_retry_seconds</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">poll_count</span> <span class="o">*</span> <span class="n">poll_interval_back_off</span><span class="p">),</span> <span class="mi">20</span>
            <span class="p">)</span>

            <span class="c1"># time out poll to prevent App running indefinitely</span>
            <span class="k">if</span> <span class="n">poll_time_total</span> <span class="o">&gt;=</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="mi">550</span><span class="p">,</span> <span class="p">[</span><span class="n">timeout</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">poll_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return current poll timeout value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poll_timeout</span>

    <span class="nd">@poll_timeout</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">poll_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the poll timeout value.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_poll_timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>

<div class="viewcode-block" id="Batch.process_all"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.process_all">[docs]</a>    <span class="k">def</span> <span class="nf">process_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process_files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Process Batch request to ThreatConnect API.</span>

<span class="sd">        Args:</span>
<span class="sd">            process_files: Send any document or report attachments to the API.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
            <span class="n">file_data</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;indicator&#39;</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="c1"># special code for debugging App using batchV2.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_batch_json</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

            <span class="c1"># store the length of the batch data to use for poll interval calculations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sd">&#39;&#39;&#39;feature=batch, event=process-all, type=group, &#39;&#39;&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;&#39;&#39;count=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">))</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;&#39;&#39;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sd">&#39;&#39;&#39;feature=batch, event=process-all, type=indicator, &#39;&#39;&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;&#39;&#39;count=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;indicator&#39;</span><span class="p">))</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;&#39;&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">process_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_files</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="Batch.process_files"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.process_files">[docs]</a>    <span class="k">def</span> <span class="nf">process_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Process Files for Documents and Reports to ThreatConnect API.</span>

<span class="sd">        Args:</span>
<span class="sd">            file_data: The file data to be processed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">xid</span><span class="p">,</span> <span class="n">content_data</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">del</span> <span class="n">file_data</span><span class="p">[</span><span class="n">xid</span><span class="p">]</span>  <span class="c1"># win or loose remove the entry</span>

            <span class="c1"># define the saved filename</span>
            <span class="n">api_branch</span> <span class="o">=</span> <span class="s1">&#39;documents&#39;</span> <span class="k">if</span> <span class="n">content_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Report&#39;</span> <span class="k">else</span> <span class="s1">&#39;reports&#39;</span>
            <span class="n">fqfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug_path_files</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span><span class="si">{</span><span class="n">api_branch</span><span class="si">}</span><span class="s1">--</span><span class="si">{</span><span class="n">xid</span><span class="si">}</span><span class="s1">--</span><span class="si">{</span><span class="n">content_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fileName&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;&#39;&#39;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># used for debug/testing to prevent upload of previously uploaded file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="n">xid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_xids</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;feature=batch-submit-files, action=skip-previously-saved-file, xid=</span><span class="si">{</span><span class="n">xid</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fqfn</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;feature=batch-submit-files, action=skip-previously-saved-file, xid=</span><span class="si">{</span><span class="n">xid</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># process the file content</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fileContent&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
                <span class="n">content_callable_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;feature=batch-submit-files, method=</span><span class="si">{</span><span class="n">content_callable_name</span><span class="si">}</span><span class="s1">, xid=</span><span class="si">{</span><span class="n">xid</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">content_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fileContent&#39;</span><span class="p">)(</span><span class="n">xid</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;feature=batch-submit-files, xid=</span><span class="si">{</span><span class="n">xid</span><span class="si">}</span><span class="s1">, event=content-null&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># write the file to disk</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fqfn</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span></div>

<div class="viewcode-block" id="Batch.registry_key"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.registry_key">[docs]</a>    <span class="k">def</span> <span class="nf">registry_key</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">key_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RegistryKey</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Registry Key data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            key_name: The key_name value for this Indicator.</span>
<span class="sd">            value_name: The value_name value for this Indicator.</span>
<span class="sd">            value_type: The value_type value for this Indicator.</span>
<span class="sd">            confidence (str, kwargs): The threat confidence for this Indicator.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            last_modified (str, kwargs): The date timestamp the Indicator was last modified.</span>
<span class="sd">            rating (str, kwargs): The threat rating for this Indicator.</span>
<span class="sd">            xid (str, kwargs): The external id for this Indicator.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            RegistryKey: An instance of the Registry Key class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indicator_obj</span> <span class="o">=</span> <span class="n">RegistryKey</span><span class="p">(</span><span class="n">key_name</span><span class="p">,</span> <span class="n">value_name</span><span class="p">,</span> <span class="n">value_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="p">(</span><span class="n">indicator_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.report"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.report">[docs]</a>    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Report</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Report data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name for this Group.</span>
<span class="sd">            file_name (str): The name for the attached file for this Group.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            file_content (str;method, kwargs): The file contents or callback method to retrieve</span>
<span class="sd">                file content.</span>
<span class="sd">            publish_date (str, kwargs): The publish datetime expression for this Group.</span>
<span class="sd">            xid (str, kwargs): The external id for this Group.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Report: An instance of the Report class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_obj</span> <span class="o">=</span> <span class="n">Report</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">(</span><span class="n">group_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.save"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save group|indicator dict or object to shelve.</span>

<span class="sd">        Best effort to save group/indicator data to disk.  If for any reason the save fails</span>
<span class="sd">        the data will still be accessible from list in memory.</span>

<span class="sd">        Args:</span>
<span class="sd">            resource: The Group or Indicator dict or object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resource_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">xid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">resource_type</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
            <span class="n">xid</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xid&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resource_type</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">type</span>
            <span class="n">xid</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">xid</span>

        <span class="k">if</span> <span class="n">resource_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">xid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">saved</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">resource_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">group_types</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># groups</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">groups_shelf</span><span class="p">[</span><span class="n">xid</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">saved</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">saved</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">[</span><span class="n">xid</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="c1"># if group was saved twice it would already be delete</span>
                        <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">resource_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">indicator_types_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># indicators</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">indicators_shelf</span><span class="p">[</span><span class="n">xid</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">saved</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">saved</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicators</span><span class="p">[</span><span class="n">xid</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="c1"># if indicator was saved twice it would already be delete</span>
                        <span class="k">pass</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">saved_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return True if saved group files exits, else False.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saved_groups</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enable_saved_file</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path_group_shelf</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path_group_shelf</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_saved_groups</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;feature=batch, event=saved-groups-file-found&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_groups</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">saved_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return True if saved indicators files exits, else False.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_indicators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saved_indicators</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enable_saved_file</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path_indicator_shelf</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path_indicator_shelf</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_saved_indicators</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;feature=batch, event=saved-indicator-file-found&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_indicators</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">saved_xids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return previously saved xids.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_xids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saved_xids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path_xids</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_path_xids</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span>
                <span class="p">):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path_xids</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_saved_xids</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_xids</span>

    <span class="nd">@saved_xids</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">saved_xids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append xid to xids saved file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path_xids</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">xid</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return batch job settings.&quot;&quot;&quot;</span>
        <span class="n">_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action</span><span class="p">,</span>
            <span class="c1"># not supported in v2 batch</span>
            <span class="c1"># &#39;attributeWriteType&#39;: self._attribute_write_type,</span>
            <span class="s1">&#39;attributeWriteType&#39;</span><span class="p">:</span> <span class="s1">&#39;Replace&#39;</span><span class="p">,</span>
            <span class="s1">&#39;haltOnError&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_halt_on_error</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
            <span class="s1">&#39;owner&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span><span class="p">,</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;V2&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_playbook_triggers_enabled</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;playbookTriggersEnabled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_playbook_triggers_enabled</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash_collision_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;hashCollisionMode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash_collision_mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_merge_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;fileMergeMode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_merge_mode</span>
        <span class="k">return</span> <span class="n">_settings</span>

<div class="viewcode-block" id="Batch.signature"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.signature">[docs]</a>    <span class="k">def</span> <span class="nf">signature</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Signature</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Signature data to Batch object.</span>

<span class="sd">        Valid file_types:</span>
<span class="sd">        + Snort </span>
<span class="sd">        + Suricata</span>
<span class="sd">        + YARA</span>
<span class="sd">        + ClamAV </span>
<span class="sd">        + OpenIOC</span>
<span class="sd">        + CybOX </span>
<span class="sd">        + Bro</span>
<span class="sd">        + Regex</span>
<span class="sd">        + SPL - Splunk  Search Processing Language</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name for this Group.</span>
<span class="sd">            file_name: The name for the attached signature for this Group.</span>
<span class="sd">            file_type: The signature type for this Group.</span>
<span class="sd">            file_text: The signature content for this Group.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            xid (str, kwargs): The external id for this Group.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Signature: An instance of the Signature class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_obj</span> <span class="o">=</span> <span class="n">Signature</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="p">,</span> <span class="n">file_text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">(</span><span class="n">group_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.submit"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.submit">[docs]</a>    <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">poll</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">errors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">process_files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">halt_on_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Submit Batch request to ThreatConnect API.</span>

<span class="sd">        By default this method will submit the job request and data and if the size of the data</span>
<span class="sd">        is below the value **synchronousBatchSaveLimit** set in System Setting it will process</span>
<span class="sd">        the request synchronously and return the batch status.  If the size of the batch is greater</span>
<span class="sd">        than the value set the batch job will be queued.</span>
<span class="sd">        Errors are not retrieve automatically and need to be enabled.</span>

<span class="sd">        If any of the submit, poll, or error methods fail the entire submit will halt at the point</span>
<span class="sd">        of failure. The behavior can be changed by setting halt_on_error to False.</span>

<span class="sd">        Each of these methods can also be called on their own for greater control of the submit</span>
<span class="sd">        process.</span>

<span class="sd">        Args:</span>
<span class="sd">            poll: If True poll batch for status.</span>
<span class="sd">            errors: If True retrieve any batch errors (only if poll is True).</span>
<span class="sd">            process_files: If true send any document or report attachments to the API.</span>
<span class="sd">            halt_on_error: If True any exception will raise an error.</span>

<span class="sd">        Returns.</span>
<span class="sd">            dict: The Batch Status from the ThreatConnect API.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get file, group, and indicator data</span>
        <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># pop any file content to pass to submit_files</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">batch_data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submit_create_and_upload</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="o">=</span><span class="n">halt_on_error</span><span class="p">)</span>
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batchStatus&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="p">)</span>
        <span class="n">batch_id</span> <span class="o">=</span> <span class="n">batch_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;feature=batch, event=submit, batch-id=</span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># job hit queue</span>
            <span class="k">if</span> <span class="n">poll</span><span class="p">:</span>
                <span class="c1"># poll for status</span>
                <span class="n">batch_data</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="n">batch_id</span><span class="o">=</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="o">=</span><span class="n">halt_on_error</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batchStatus&#39;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                    <span class="c1"># retrieve errors</span>
                    <span class="n">error_groups</span> <span class="o">=</span> <span class="n">batch_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errorGroupCount&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">error_indicators</span> <span class="o">=</span> <span class="n">batch_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errorIndicatorCount&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">error_groups</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">error_indicators</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">batch_data</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">(</span><span class="n">batch_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># can&#39;t process files if status is unknown (polling must be enabled)</span>
                <span class="n">process_files</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">process_files</span><span class="p">:</span>
            <span class="c1"># submit file data after batch job is complete</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">submit_thread</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;submit-files&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit_files</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="p">,),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">batch_data</span></div>

<div class="viewcode-block" id="Batch.submit_all"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.submit_all">[docs]</a>    <span class="k">def</span> <span class="nf">submit_all</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">poll</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">errors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">process_files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">halt_on_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Submit Batch request to ThreatConnect API.</span>

<span class="sd">        By default this method will submit the job request and data and if the size of the data</span>
<span class="sd">        is below the value **synchronousBatchSaveLimit** set in System Setting it will process</span>
<span class="sd">        the request synchronously and return the batch status.  If the size of the batch is greater</span>
<span class="sd">        than the value set the batch job will be queued.</span>
<span class="sd">        Errors are not retrieve automatically and need to be enabled.</span>

<span class="sd">        If any of the submit, poll, or error methods fail the entire submit will halt at the point</span>
<span class="sd">        of failure. The behavior can be changed by setting halt_on_error to False.</span>

<span class="sd">        Each of these methods can also be called on their own for greater control of the submit</span>
<span class="sd">        process.</span>

<span class="sd">        Args:</span>
<span class="sd">            poll: If True poll batch for status.</span>
<span class="sd">            errors: If True retrieve any batch errors (only if poll is True).</span>
<span class="sd">            process_files: If true send any document or report attachments to the API.</span>
<span class="sd">            halt_on_error: If True any exception will raise an error.</span>

<span class="sd">        Returns.</span>
<span class="sd">            dict: The Batch Status from the ThreatConnect API.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch_data_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">batch_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">batch_id</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># get file, group, and indicator data</span>
            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

            <span class="c1"># break loop when end of data is reached</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;indicator&#39;</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
                <span class="c1"># no need to process files on a delete batch job</span>
                <span class="n">process_files</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># while waiting of FR for delete support in createAndUpload submit delete request</span>
                <span class="c1"># the old way (submit job + submit data), still using V2.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># pylint: disable=len-as-condition</span>
                    <span class="n">batch_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="n">halt_on_error</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">batch_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">batch_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_data</span><span class="p">(</span>
                            <span class="n">batch_id</span><span class="o">=</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="o">=</span><span class="n">halt_on_error</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">batch_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># pop any file content to pass to submit_files</span>
                <span class="n">file_data</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">batch_data</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">submit_create_and_upload</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="o">=</span><span class="n">halt_on_error</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batchStatus&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="p">)</span>
                <span class="n">batch_id</span> <span class="o">=</span> <span class="n">batch_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">batch_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;feature=batch, event=status, batch-id=</span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># job hit queue</span>
                <span class="k">if</span> <span class="n">poll</span><span class="p">:</span>
                    <span class="c1"># poll for status</span>
                    <span class="n">batch_data</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="o">=</span><span class="n">halt_on_error</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batchStatus&#39;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                        <span class="c1"># retrieve errors</span>
                        <span class="n">error_count</span> <span class="o">=</span> <span class="n">batch_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errorCount&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">error_groups</span> <span class="o">=</span> <span class="n">batch_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errorGroupCount&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">error_indicators</span> <span class="o">=</span> <span class="n">batch_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errorIndicatorCount&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">error_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">error_groups</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">error_indicators</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">batch_data</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">(</span><span class="n">batch_id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># can&#39;t process files if status is unknown (polling must be enabled)</span>
                    <span class="n">process_files</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">process_files</span><span class="p">:</span>
                <span class="c1"># submit file data after batch job is complete</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">submit_thread</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;submit-files&#39;</span><span class="p">,</span>
                        <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit_files</span><span class="p">,</span>
                        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="p">,),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">batch_data_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_data</span><span class="p">)</span>

            <span class="c1"># write errors for debugging</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_error_json</span><span class="p">(</span><span class="n">batch_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">batch_data_array</span></div>

<div class="viewcode-block" id="Batch.submit_callback"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.submit_callback">[docs]</a>    <span class="k">def</span> <span class="nf">submit_callback</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">halt_on_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Submit batch data to ThreatConnect and poll in a separate thread.</span>

<span class="sd">        The &quot;normal&quot; submit methods run in serial which will block when the batch poll is running.</span>
<span class="sd">        Using this method the submit is done in serial, but the poll method is run in a thread,</span>
<span class="sd">        which should allow the App to continue downloading and processing data while the batch</span>
<span class="sd">        poll process is running. Only one batch submission is allowed at a time so that any</span>
<span class="sd">        critical errors returned from batch can be handled before submitting a new batch job.</span>

<span class="sd">        Args:</span>
<span class="sd">            callback: The callback method that will handle</span>
<span class="sd">                the batch status when polling is complete.</span>
<span class="sd">            content: The dict of groups and indicator data (e.g., {&quot;group&quot;: [], &quot;indiciator&quot;: []}).</span>
<span class="sd">            halt_on_error: If True the process should halt if any errors are encountered.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: Raised on invalid callback method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: False when there is not data to process, else True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># user provided content or grab content from local group/indicator lists</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># process content</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="n">file_data</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># return False when end of data is reached</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;indicator&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># block here is there is already a batch submission being processed</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_submit_thread</span><span class="p">,</span> <span class="s1">&#39;is_alive&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;feature=batch, event=progress, status=blocked, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;is-alive=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_submit_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_submit_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;feature=batch, event=progress, status=released, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;is-alive=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_submit_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

        <span class="c1"># submit the data and collect the response</span>
        <span class="n">batch_data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submit_create_and_upload</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="o">=</span><span class="n">halt_on_error</span><span class="p">)</span>
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batchStatus&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;feature=batch, event=submit-callback, batch-data=</span><span class="si">{</span><span class="n">batch_data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># launch batch polling in a thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_submit_thread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_thread</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;submit-poll&#39;</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit_callback_thread</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">batch_data</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">file_data</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Batch.submit_callback_thread"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.submit_callback_thread">[docs]</a>    <span class="k">def</span> <span class="nf">submit_callback_thread</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">batch_data</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">file_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">halt_on_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Submit data in a thread.&quot;&quot;&quot;</span>
        <span class="n">batch_id</span> <span class="o">=</span> <span class="n">batch_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;feature=batch, event=progress, batch-id=</span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_id</span><span class="p">:</span>
            <span class="c1"># when batch_id is None it indicates that batch submission was small enough to be</span>
            <span class="c1"># processed inline (without being queued)</span>

            <span class="c1"># poll for status</span>
            <span class="n">batch_status</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="o">=</span><span class="n">halt_on_error</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batchStatus&#39;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># retrieve errors</span>
            <span class="n">error_count</span> <span class="o">=</span> <span class="n">batch_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errorCount&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">error_groups</span> <span class="o">=</span> <span class="n">batch_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errorGroupCount&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">error_indicators</span> <span class="o">=</span> <span class="n">batch_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errorIndicatorCount&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">error_groups</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">error_indicators</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">batch_status</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">(</span><span class="n">batch_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch_status</span> <span class="o">=</span> <span class="n">batch_data</span>

        <span class="c1"># launch file upload in a thread *after* batch status is returned. while only one batch</span>
        <span class="c1"># submission thread is allowed, there is no limit on file upload threads. the upload</span>
        <span class="c1"># status returned by file upload will be ignored when running in a thread.</span>
        <span class="k">if</span> <span class="n">file_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">submit_thread</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;submit-files&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit_files</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="p">,),</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># send batch_status to callback</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">callback</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;feature=batch, event=calling-callback&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">batch_status</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;feature=batch, event=callback-error, err=&quot;&quot;&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&quot;&quot;&quot;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Batch.submit_create_and_upload"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.submit_create_and_upload">[docs]</a>    <span class="k">def</span> <span class="nf">submit_create_and_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Submit Batch request to ThreatConnect API.</span>

<span class="sd">        Args:</span>
<span class="sd">            content: The dict of groups and indicator data.</span>
<span class="sd">            halt_on_error: If True the process should halt if any errors are encountered.</span>

<span class="sd">        Returns.</span>
<span class="sd">            dict: The Batch Status from the ThreatConnect API.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check global setting for override</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">halt_on_batch_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">halt_on_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halt_on_batch_error</span>

        <span class="c1"># special code for debugging App using batchV2.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_batch_json</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="c1"># store the length of the batch data to use for poll interval calculations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sd">&#39;&#39;&#39;feature=batch, event=submit-create-and-upload, type=group, &#39;&#39;&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;&#39;&#39;count=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">))</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;&#39;&#39;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sd">&#39;&#39;&#39;feature=batch, event=submit-create-and-upload, type=indicator, &#39;&#39;&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;&#39;&#39;count=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;indicator&#39;</span><span class="p">))</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;&#39;&#39;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)),</span> <span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">content</span><span class="p">)))</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;includeAdditional&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">}</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/v2/batch/createAndUpload&#39;</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span> <span class="ow">or</span> <span class="s1">&#39;application/json&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="mi">10510</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">],</span> <span class="n">halt_on_error</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="mi">10505</span><span class="p">,</span> <span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">halt_on_error</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="Batch.submit_data"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.submit_data">[docs]</a>    <span class="k">def</span> <span class="nf">submit_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Submit Batch request to ThreatConnect API.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_id: The batch id of the current job.</span>
<span class="sd">            content: The dict of groups and indicator data.</span>
<span class="sd">            halt_on_error (Optional[bool] = True): If True the process</span>
<span class="sd">                should halt if any errors are encountered.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The response data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check global setting for override</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">halt_on_batch_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">halt_on_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halt_on_batch_error</span>

        <span class="c1"># store the length of the batch data to use for poll interval calculations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_data_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;indicator&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;feature=batch, action=submit-data, batch-size=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_data_count</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/octet-stream&#39;</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/v2/batch/</span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span> <span class="ow">or</span> <span class="s1">&#39;application/json&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="mi">10525</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">],</span> <span class="n">halt_on_error</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="mi">10520</span><span class="p">,</span> <span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">halt_on_error</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Batch.submit_files"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.submit_files">[docs]</a>    <span class="k">def</span> <span class="nf">submit_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Submit Files for Documents and Reports to ThreatConnect API.</span>

<span class="sd">        Critical Errors</span>

<span class="sd">        * There is insufficient document storage allocated to this account.</span>

<span class="sd">        Args:</span>
<span class="sd">            halt_on_error: If True any exception will raise an error.</span>
<span class="sd">            file_data: The file data to be submitted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The upload status for each xid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check global setting for override</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">halt_on_file_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">halt_on_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halt_on_file_error</span>

        <span class="n">upload_status</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;feature=batch, action=submit-files, count=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">xid</span><span class="p">,</span> <span class="n">content_data</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">file_data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">del</span> <span class="n">file_data</span><span class="p">[</span><span class="n">xid</span><span class="p">]</span>  <span class="c1"># win or loose remove the entry</span>
            <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># used for debug/testing to prevent upload of previously uploaded file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="n">xid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_xids</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;feature=batch-submit-files, action=skip-previously-saved-file, xid=</span><span class="si">{</span><span class="n">xid</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># process the file content</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fileContent&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">content_callable_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;feature=batch-submit-files, method=</span><span class="si">{</span><span class="n">content_callable_name</span><span class="si">}</span><span class="s1">, xid=</span><span class="si">{</span><span class="n">xid</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">content_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fileContent&#39;</span><span class="p">)(</span><span class="n">xid</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;feature=batch, event=file-download-exception, err=&quot;&quot;&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&quot;&quot;&quot;&#39;</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">upload_status</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;uploaded&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;xid&#39;</span><span class="p">:</span> <span class="n">xid</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;feature=batch-submit-files, xid=</span><span class="si">{</span><span class="n">xid</span><span class="si">}</span><span class="s1">, event=content-null&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">api_branch</span> <span class="o">=</span> <span class="s1">&#39;documents&#39;</span>
            <span class="k">if</span> <span class="n">content_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Report&#39;</span><span class="p">:</span>
                <span class="n">api_branch</span> <span class="o">=</span> <span class="s1">&#39;reports&#39;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="n">content_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fileName&#39;</span><span class="p">):</span>
                <span class="c1"># special code for debugging App using batchV2.</span>
                <span class="n">fqfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_path_files</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span><span class="si">{</span><span class="n">api_branch</span><span class="si">}</span><span class="s1">--</span><span class="si">{</span><span class="n">xid</span><span class="si">}</span><span class="s1">--</span><span class="si">{</span><span class="n">content_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fileName&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;&#39;&#39;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fqfn</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

            <span class="c1"># Post File</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/v2/groups/</span><span class="si">{</span><span class="n">api_branch</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">xid</span><span class="si">}</span><span class="s1">/upload&#39;</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/octet-stream&#39;</span><span class="p">}</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;owner&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span><span class="p">,</span> <span class="s1">&#39;updateIfExists&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">}</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_file_content</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                <span class="c1"># use PUT method if file already exists</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;feature=batch, event=401-from-post, action=switch-to-put&#39;</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_file_content</span><span class="p">(</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="mi">585</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">],</span> <span class="n">halt_on_error</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_saved_file</span> <span class="ow">and</span> <span class="n">xid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_xids</span><span class="p">:</span>
                <span class="c1"># save xid &quot;if&quot; successfully uploaded and not already saved</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saved_xids</span> <span class="o">=</span> <span class="n">xid</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;feature=batch, event=file-upload, status=</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s1">, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;xid=</span><span class="si">{</span><span class="n">xid</span><span class="si">}</span><span class="s1">, remaining=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="n">upload_status</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;uploaded&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span> <span class="s1">&#39;xid&#39;</span><span class="p">:</span> <span class="n">xid</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">upload_status</span></div>

<div class="viewcode-block" id="Batch.submit_file_content"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.submit_file_content">[docs]</a>    <span class="k">def</span> <span class="nf">submit_file_content</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">halt_on_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Submit File Content for Documents and Reports to ThreatConnect API.</span>

<span class="sd">        Args:</span>
<span class="sd">            method: The HTTP method for the request (POST, PUT).</span>
<span class="sd">            url: The URL for the request.</span>
<span class="sd">            data: The body (data) for the request.</span>
<span class="sd">            headers: The headers for the request.</span>
<span class="sd">            params: The query string parameters for the request.</span>
<span class="sd">            halt_on_error: If True any exception will raise an error.</span>

<span class="sd">        Returns:</span>
<span class="sd">            requests.models.Response: The response from the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="mi">580</span><span class="p">,</span> <span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">halt_on_error</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="Batch.submit_job"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.submit_job">[docs]</a>    <span class="k">def</span> <span class="nf">submit_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">halt_on_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Submit Batch request to ThreatConnect API.</span>

<span class="sd">        Args:</span>
<span class="sd">            halt_on_error: If True any exception will raise an error.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The batch id from the API response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check global setting for override</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">halt_on_batch_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">halt_on_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">halt_on_batch_error</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/v2/batch&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="mi">10505</span><span class="p">,</span> <span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">halt_on_error</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span> <span class="ow">or</span> <span class="s1">&#39;application/json&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="mi">10510</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">],</span> <span class="n">halt_on_error</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;Success&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="mi">10510</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">],</span> <span class="n">halt_on_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;feature=batch, event=submit-job, status=</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batchId&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Batch.submit_thread"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.submit_thread">[docs]</a>    <span class="k">def</span> <span class="nf">submit_thread</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Start a submit thread.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the thread.</span>
<span class="sd">            target: The method to call for the thread.</span>
<span class="sd">            args: The args to pass to the target method.</span>
<span class="sd">            kwargs: Additional args.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;feature=batch, event=submit-thread, name=</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">t</span></div>

<div class="viewcode-block" id="Batch.threat"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.threat">[docs]</a>    <span class="k">def</span> <span class="nf">threat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Threat</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add Threat data to Batch object</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name for this Group.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            xid (str, kwargs): The external id for this Group.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Threat: An instance of the Threat class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_obj</span> <span class="o">=</span> <span class="n">Threat</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">(</span><span class="n">group_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.user_agent"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.user_agent">[docs]</a>    <span class="k">def</span> <span class="nf">user_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserAgent</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add User Agent data to Batch object</span>

<span class="sd">        Args:</span>
<span class="sd">            text: The value for this Indicator.</span>
<span class="sd">            confidence (str, kwargs): The threat confidence for this Indicator.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            last_modified (str, kwargs): The date timestamp the Indicator was last modified.</span>
<span class="sd">            rating (str, kwargs): The threat rating for this Indicator.</span>
<span class="sd">            xid (str, kwargs): The external id for this Indicator.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            UserAgent: An instance of the UserAgent class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indicator_obj</span> <span class="o">=</span> <span class="n">UserAgent</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="p">(</span><span class="n">indicator_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.url"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.url">[docs]</a>    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">URL</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add URL Address data to Batch object.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str): The value for this Indicator.</span>
<span class="sd">            confidence (str, kwargs): The threat confidence for this Indicator.</span>
<span class="sd">            date_added (str, kwargs): The date timestamp the Indicator was created.</span>
<span class="sd">            last_modified (str, kwargs): The date timestamp the Indicator was last modified.</span>
<span class="sd">            rating (str, kwargs): The threat rating for this Indicator.</span>
<span class="sd">            xid (str, kwargs): The external id for this Indicator.</span>
<span class="sd">            store: (bool, kwargs): Advanced - Defaults to True. If True</span>
<span class="sd">                the indicator data will be stored in instance list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            URL: An instance of the URL class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indicator_obj</span> <span class="o">=</span> <span class="n">URL</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indicator</span><span class="p">(</span><span class="n">indicator_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="Batch.write_error_json"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.write_error_json">[docs]</a>    <span class="k">def</span> <span class="nf">write_error_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errors</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write the errors to a JSON file for debuging purposes.</span>

<span class="sd">        Args:</span>
<span class="sd">            errors: A list of errors to write out.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># get timestamp as a string without decimal place and consistent length</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10000000</span><span class="p">))</span>
            <span class="n">error_json_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path_batch</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;errors-</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1">.json.gz&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">error_json_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wt&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span></div>

<div class="viewcode-block" id="Batch.write_batch_json"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.write_batch_json">[docs]</a>    <span class="k">def</span> <span class="nf">write_batch_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write batch json data to a file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="n">content</span><span class="p">:</span>
            <span class="c1"># get timestamp as a string without decimal place and consistent length</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10000000</span><span class="p">))</span>
            <span class="n">batch_json_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_path_batch</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;batch-</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1">.json.gz&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">batch_json_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wt&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">group_len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the number of current groups.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_shelf</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">indicator_len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the number of current indicators.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indicators_shelf</span><span class="p">)</span>

<div class="viewcode-block" id="Batch.__len__"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.__len__">[docs]</a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the number of groups and indicators.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_len</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicator_len</span></div>

<div class="viewcode-block" id="Batch.__str__"><a class="viewcode-back" href="../../../tcex_docs/tcex.batch.html#tcex.batch.batch.Batch.__str__">[docs]</a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;Return string represtentation of object.&quot;&quot;&quot;</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">group_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">group_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_shelf</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="n">indicators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">indicator_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indicator_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">indicators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indicator_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indicators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indicator_data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">indicator_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators_shelf</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indicator_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">indicators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indicator_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indicators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indicator_data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">groups</span><span class="p">,</span> <span class="s1">&#39;indicators&#39;</span><span class="p">:</span> <span class="n">indicators</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>
</pre></div>

           </div>

          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2016, ThreatConnect Inc.

    </p>
  </div>

</footer>
        </div>
      </div>

    </section>

  </div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>






</body>
</html>
