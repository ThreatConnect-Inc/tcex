

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Building Apps: Templates (tcinit) &mdash; TcEx 1.0.7 documentation</title>








  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>


      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>

    <script type="text/javascript" src="_static/js/theme.js"></script>




  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Building Apps: Dependencies (tclib)" href="building_apps_tclib.html" />
    <link rel="prev" title="Building Apps: Quick Start" href="building_apps_quickstart.html" />
</head>

<body class="wy-body-for-nav">


  <div class="wy-grid-for-nav">

    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >



            <a href="index.html" class="icon icon-home"> TcEx



          </a>




              <div class="version">
                1.0.7
              </div>




<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">






              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="building_apps_quickstart.html">Building Apps: Quick Start</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Building Apps: Templates (tcinit)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#summary">Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#common-usage">Common Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#job-app-templates">Job App Templates</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#job-job">Job (job)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#app-py">app.py</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#job-ingress-job-ingress">Job Ingress (job_ingress)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">app.py</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#playbook-app-templates">Playbook App Templates</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#playbook-playbook">Playbook (playbook)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">app.py</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#playbook-actions-playbook-actions">Playbook Actions (playbook_actions)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">app.py</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#playbook-utility-playbook-utility">Playbook Utility (playbook_utility)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">app.py</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#external-app-templates">External App Templates</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#external-external">External (external)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">app.py</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#external-ingress-external-ingress">External Ingress (external_ingress)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id6">app.py</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="building_apps_tclib.html">Building Apps: Dependencies (tclib)</a></li>
<li class="toctree-l1"><a class="reference internal" href="building_apps_tcpackage.html">Building Apps: Packaging (tcpackage)</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing_apps_tcprofile.html">Testing Apps: Profiles (tcprofile)</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing_apps_tcrun.html">Testing Apps: Running Profiles (tcrun)</a></li>
<li class="toctree-l1"><a class="reference internal" href="app_deployment_configuration.html">App-Deployment Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="app_directory_structure.html">App-Directory Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_batch.html">Module: Batch</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_metrics.html">Module: Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_notifications.html">Module: Notifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_playbook.html">Module: Playbooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_request.html">Module: Requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_resource.html">Module: Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_ti.html">Module: Threat Intelligence</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_utils.html">Module: Utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="authorization.html">Authorization (Token/HMAC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="exit.html">Exit</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="message_tc.html">Message TC</a></li>
<li class="toctree-l1"><a class="reference internal" href="parser.html">Parser/Args</a></li>
<li class="toctree-l1"><a class="reference internal" href="proxies.html">Proxies</a></li>
<li class="toctree-l1"><a class="reference internal" href="results_tc.html">Results TC</a></li>
<li class="toctree-l1"><a class="reference internal" href="release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="tcex_docs/modules.html">TcEx Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="tcex_docs/modules.html#tcex-cli">TcEx CLI</a></li>
</ul>



        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">


      <nav class="wy-nav-top" aria-label="top navigation">

          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">TcEx</a>

      </nav>


      <div class="wy-nav-content">

        <div class="rst-content">

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">

      <li><a href="index.html">Docs</a> &raquo;</li>

      <li>Building Apps: Templates (tcinit)</li>


      <li class="wy-breadcrumbs-aside">



      </li>

  </ul>


  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <div class="section" id="building-apps-templates-tcinit">
<span id="building-apps-tcinit"></span><h1>Building Apps: Templates (tcinit)<a class="headerlink" href="#building-apps-templates-tcinit" title="Permalink to this headline">¶</a></h1>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">tcinit</span></code> CLI tool provides a simple interface to begin a new project from a template and to keep Framework files updated.  There are several templates that support specific-use cases. Most templates are working Apps that can easily be modified to the developer’s use case.</p>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>To get the latest usage and template choices for <code class="docutils literal notranslate"><span class="pre">tcinit</span></code>, run <code class="docutils literal notranslate"><span class="pre">tcinit</span> <span class="pre">-h</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>usage: tcinit <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>--branch <span class="o">{</span>master,develop<span class="o">}]</span>
              <span class="o">[</span>--action <span class="o">{</span>create,update,migrate<span class="o">}]</span>
              <span class="o">[</span>--template <span class="o">{</span>external,external_ingress,job,job_batch,playbook,playbook_actions,playbook_utility<span class="o">}]</span>
              <span class="o">[</span>--force<span class="o">]</span>

optional arguments:
  -h, --help            Show this <span class="nb">help</span> message and <span class="nb">exit</span>
  --branch <span class="o">{</span>master,develop<span class="o">}</span>
                        git branch.
  --action <span class="o">{</span>create,update,migrate<span class="o">}</span>
                        <span class="o">(</span>default: create<span class="o">)</span> Choose <span class="s2">&quot;create&quot;</span> to initialize a new
                        App, <span class="s2">&quot;update&quot;</span> to download updates to App framework
                        files, and <span class="s2">&quot;migrate&quot;</span> to update a non App Builder
                        compliant App to use a standard template.
  --template <span class="o">{</span>external,external_ingress,job,job_batch,playbook,playbook_actions,playbook_utility<span class="o">}</span>
                        <span class="o">(</span>default: playbook<span class="o">)</span> Choose an appropriate App template <span class="k">for</span> the current
                        project.
  --force               Enable this flag to forcibly overwrite existing files
                        in the current working directory.
</pre></div>
</div>
<div class="section" id="common-usage">
<h3>Common Usage<a class="headerlink" href="#common-usage" title="Permalink to this headline">¶</a></h3>
<p>To initialize a new App, run this command from the project directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tcinit --template playbook_utility
</pre></div>
</div>
<p>To update an existing App, run the command below from the project directory. The <strong>update</strong> action will download all Frameworks files to ensure that these files are the latest with any bug fixes or updates.  It is best practice to run the <strong>update</strong> action whenever an App is being updated for new features or bug fixes.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tcinit --action update --template playbook
</pre></div>
</div>
</div>
</div>
<div class="section" id="job-app-templates">
<h2>Job App Templates<a class="headerlink" href="#job-app-templates" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">run()</span></code> method is the default method that is called when an App is executed. For simple Apps, the core logic of the App can be written in this method.  For more advanced Apps, additional methods can be added to the <strong>app.py</strong> file, if required.</p>
<div class="section" id="job-job">
<h3>Job (job)<a class="headerlink" href="#job-job" title="Permalink to this headline">¶</a></h3>
<p>This basic template provides the structure for a Job App without any logic.  This template is intended for advanced users that only require the App structure.</p>
<div class="section" id="app-py">
<h4>app.py<a class="headerlink" href="#app-py" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;ThreatConnect Job App&quot;&quot;&quot;</span>

<span class="c1"># Import default Job Class (Required)</span>
<span class="kn">from</span> <span class="nn">job_app</span> <span class="kn">import</span> <span class="n">JobApp</span>


<span class="k">class</span> <span class="nc">App</span><span class="p">(</span><span class="n">JobApp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Job App&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the App main logic.</span>

<span class="sd">        This method should contain the core logic of the App.</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="job-ingress-job-ingress">
<h3>Job Ingress (job_ingress)<a class="headerlink" href="#job-ingress-job-ingress" title="Permalink to this headline">¶</a></h3>
<p>This template provides a working example of how to download remote-threat intel (md5 hash Indicators) and write the data in the ThreatConnect platform using the TcEx <a class="reference internal" href="module_batch.html#module-batch"><span class="std std-ref">Batch Module</span></a>.  The URL is defined in the <code class="docutils literal notranslate"><span class="pre">init()</span></code> method for convenience. In the <code class="docutils literal notranslate"><span class="pre">run()</span></code> method, the Batch module is instantiated. Next, the data is retrieved from the remote URL and written to the Batch module. Finally, the Batch Job is submitted to ThreatConnect for processing.</p>
<div class="section" id="id1">
<h4>app.py<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;ThreatConnect Job App&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">csv</span>

<span class="c1"># Import default Job Class (Required)</span>
<span class="kn">from</span> <span class="nn">job_app</span> <span class="kn">import</span> <span class="n">JobApp</span>


<span class="k">class</span> <span class="nc">App</span><span class="p">(</span><span class="n">JobApp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Job App&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_tcex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize class properties.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">App</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_tcex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://feodotracker.abuse.ch/downloads/malware_hashes.csv&#39;</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run main App logic.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">tc_owner</span><span class="p">)</span>

        <span class="c1"># using tcex requests to get built-in features (e.g., proxy, logging, retries)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">request</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="n">decoded_content</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

                <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">decoded_content</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                    <span class="c1"># CSV headers</span>
                    <span class="c1"># Firstseen,MD5hash,Malware</span>

                    <span class="c1"># skip comments</span>
                    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="c1"># create batch entry</span>
                    <span class="n">file_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rating</span><span class="o">=</span><span class="s1">&#39;4.0&#39;</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="s1">&#39;100&#39;</span><span class="p">)</span>
                    <span class="n">file_hash</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">occurrence</span> <span class="o">=</span> <span class="n">file_hash</span><span class="o">.</span><span class="n">occurrence</span><span class="p">()</span>
                    <span class="n">occurrence</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file_hash</span><span class="p">)</span>  <span class="c1"># optionally save object to disk</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Failed to download CSV data.&#39;</span><span class="p">)</span>

        <span class="c1"># submit batch job</span>
        <span class="n">batch_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">submit_all</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="n">batch_status</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exit_message</span> <span class="o">=</span> <span class="s1">&#39;Downloaded data and create batch job.&#39;</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section" id="playbook-app-templates">
<h2>Playbook App Templates<a class="headerlink" href="#playbook-app-templates" title="Permalink to this headline">¶</a></h2>
<div class="section" id="playbook-playbook">
<h3>Playbook (playbook)<a class="headerlink" href="#playbook-playbook" title="Permalink to this headline">¶</a></h3>
<p>This template provides the structure for a Playbook App without any logic.  This template is intended for advanced users that only require the App structure.</p>
<div class="section" id="id2">
<h4>app.py<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;ThreatConnect Playbook App&quot;&quot;&quot;</span>

<span class="c1"># Import default Playbook Class (Required)</span>
<span class="kn">from</span> <span class="nn">playbook_app</span> <span class="kn">import</span> <span class="n">PlaybookApp</span>


<span class="k">class</span> <span class="nc">App</span><span class="p">(</span><span class="n">PlaybookApp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Playbook App&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the App main logic.</span>

<span class="sd">        This method should contain the core logic of the App.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">write_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the Playbook output variables.</span>

<span class="sd">        This method should be overridden with the output variables defined in the install.json</span>
<span class="sd">        configuration file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="playbook-actions-playbook-actions">
<h3>Playbook Actions (playbook_actions)<a class="headerlink" href="#playbook-actions-playbook-actions" title="Permalink to this headline">¶</a></h3>
<p>This template provides a working example of <strong>actions</strong> in a Playbook App. Using the Actions feature, a single Playbook can have multiple actions to perform different operations on the provided data. Python decorators are heavily used in this template to provide a clean interface to process inputs for an App.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<dl class="simple">
<dt><a class="reference internal" href="tcex_docs/tcex.tcex_app_decorators.html#module-tcex.tcex_app_decorators" title="tcex.tcex_app_decorators"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tcex_app_decorators</span></code></a></dt><dd><p>Inline documentation of App decorators</p>
</dd>
</dl>
</div>
<div class="section" id="id3">
<h4>app.py<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot; ThreatConnect Playbook App &quot;&quot;&quot;</span>

<span class="c1"># Import default Playbook Class (Required)</span>
<span class="kn">from</span> <span class="nn">playbook_app</span> <span class="kn">import</span> <span class="n">PlaybookApp</span>
<span class="kn">from</span> <span class="nn">tcex</span> <span class="kn">import</span> <span class="n">IterateOnArg</span><span class="p">,</span> <span class="n">OnException</span><span class="p">,</span> <span class="n">OnSuccess</span><span class="p">,</span> <span class="n">Output</span>


<span class="c1"># pylint: disable=R0201</span>
<span class="k">class</span> <span class="nc">App</span><span class="p">(</span><span class="n">PlaybookApp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Playbook App&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_tcex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize class properties.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">App</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_tcex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_strings</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@IterateOnArg</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="s1">&#39;input_strings&#39;</span><span class="p">)</span>
    <span class="nd">@OnException</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Failed to run capitalize operation.&#39;</span><span class="p">)</span>
    <span class="nd">@OnSuccess</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Successfully ran capitalize operation.&#39;</span><span class="p">)</span>
    <span class="nd">@Output</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s1">&#39;output_strings&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">capitalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return capitalized string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>

    <span class="nd">@IterateOnArg</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="s1">&#39;input_strings&#39;</span><span class="p">)</span>
    <span class="nd">@OnException</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Failed to run lowercase operation.&#39;</span><span class="p">)</span>
    <span class="nd">@OnSuccess</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Successfully ran lowercase operation.&#39;</span><span class="p">)</span>
    <span class="nd">@Output</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s1">&#39;output_strings&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">lowercase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string in lowercase.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="nd">@IterateOnArg</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="s1">&#39;input_strings&#39;</span><span class="p">)</span>
    <span class="nd">@OnException</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Failed to run reverse operation.&#39;</span><span class="p">)</span>
    <span class="nd">@OnSuccess</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Successfully ran reverse operation.&#39;</span><span class="p">)</span>
    <span class="nd">@Output</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s1">&#39;output_strings&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string reversed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">string</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@IterateOnArg</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="s1">&#39;input_strings&#39;</span><span class="p">)</span>
    <span class="nd">@OnException</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Failed to run strip operation.&#39;</span><span class="p">)</span>
    <span class="nd">@OnSuccess</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Successfully ran strip operation.&#39;</span><span class="p">)</span>
    <span class="nd">@Output</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s1">&#39;output_strings&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string stripping any whitespaces at beginning and end.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="nd">@IterateOnArg</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="s1">&#39;input_strings&#39;</span><span class="p">)</span>
    <span class="nd">@OnException</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Failed to run swap case operation.&#39;</span><span class="p">)</span>
    <span class="nd">@OnSuccess</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Successfully ran swap case operation.&#39;</span><span class="p">)</span>
    <span class="nd">@Output</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s1">&#39;output_strings&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">swap_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string with the case swapped.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">swapcase</span><span class="p">()</span>

    <span class="nd">@IterateOnArg</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="s1">&#39;input_strings&#39;</span><span class="p">)</span>
    <span class="nd">@OnException</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Failed to run title case operation.&#39;</span><span class="p">)</span>
    <span class="nd">@OnSuccess</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Successfully ran title case operation.&#39;</span><span class="p">)</span>
    <span class="nd">@Output</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s1">&#39;output_strings&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">title_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string in title case.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

    <span class="nd">@IterateOnArg</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="s1">&#39;input_strings&#39;</span><span class="p">)</span>
    <span class="nd">@OnException</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Failed to run uppercase operation.&#39;</span><span class="p">)</span>
    <span class="nd">@OnSuccess</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Successfully ran uppercase operation.&#39;</span><span class="p">)</span>
    <span class="nd">@Output</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s1">&#39;output_strings&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">uppercase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string in uppercase.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">write_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write the Playbook output variables. &quot;&quot;&quot;</span>
        <span class="c1"># output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;output_strings: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_strings</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">playbook</span><span class="o">.</span><span class="n">create_output</span><span class="p">(</span><span class="s1">&#39;string.operation&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">tc_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">playbook</span><span class="o">.</span><span class="n">create_output</span><span class="p">(</span><span class="s1">&#39;string.outputs&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_strings</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_strings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">playbook</span><span class="o">.</span><span class="n">create_output</span><span class="p">(</span><span class="s1">&#39;string.outputs.0&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_strings</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">playbook</span><span class="o">.</span><span class="n">create_output</span><span class="p">(</span><span class="s1">&#39;string.outputs.count&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_strings</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="playbook-utility-playbook-utility">
<h3>Playbook Utility (playbook_utility)<a class="headerlink" href="#playbook-utility-playbook-utility" title="Permalink to this headline">¶</a></h3>
<p>This template provides a working example of a utility App that takes an input, analyzes or modifies the data, and writes the results as output.</p>
<div class="section" id="id4">
<h4>app.py<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;ThreatConnect Playbook App&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="c1"># Import default Playbook Class (Required)</span>
<span class="kn">from</span> <span class="nn">playbook_app</span> <span class="kn">import</span> <span class="n">PlaybookApp</span>


<span class="c1"># pylint: disable=W0201</span>
<span class="k">class</span> <span class="nc">App</span><span class="p">(</span><span class="n">PlaybookApp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Playbook App&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_tcex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize class properties.</span>

<span class="sd">        This method can be OPTIONALLY overridden.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">App</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_tcex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretty_json</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># def done(self):</span>
    <span class="c1">#     &quot;&quot;&quot;Perform cleanup work before after App main logic.&quot;&quot;&quot;</span>
    <span class="c1">#     self.tcex.log.debug(&#39;Running done.&#39;)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the App main logic.</span>

<span class="sd">        This method should contain the core logic of the App.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># read inputs</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">playbook</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">indent</span><span class="p">))</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">playbook</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">json_data</span><span class="p">)</span>

        <span class="c1"># get the playbook variable type</span>
        <span class="n">json_data_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">playbook</span><span class="o">.</span><span class="n">variable_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">json_data</span><span class="p">)</span>

        <span class="c1"># convert string input to dict</span>
        <span class="k">if</span> <span class="n">json_data_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;String&#39;</span><span class="p">]:</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>

        <span class="c1"># generate the new &quot;pretty&quot; json (this will be used as an option variable)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pretty_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">sort_keys</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Failed parsing JSON data.&#39;</span><span class="p">)</span>

        <span class="c1"># set the App exit message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_message</span> <span class="o">=</span> <span class="s1">&#39;JSON prettified.&#39;</span>

    <span class="c1"># def start(self):</span>
    <span class="c1">#     &quot;&quot;&quot;Perform prep work before running App main logic.&quot;&quot;&quot;</span>
    <span class="c1">#     self.tcex.log.debug(&#39;Running start.&#39;)</span>

    <span class="k">def</span> <span class="nf">write_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the Playbook output variables.</span>

<span class="sd">        This method should be overridden with the output variables defined in the install.json</span>
<span class="sd">        configuration file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing Output&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">playbook</span><span class="o">.</span><span class="n">create_output</span><span class="p">(</span><span class="s1">&#39;json.pretty&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretty_json</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section" id="external-app-templates">
<h2>External App Templates<a class="headerlink" href="#external-app-templates" title="Permalink to this headline">¶</a></h2>
<p>The TcEx Framework provides methods to build an App to run in the ThreatConnect Exchange environment.  However, the TcEx Frameworks also supports writing Apps that run external to the ThreatConnect Exchange environment. Two methods of injecting CLI args are supported.  The first method ,``self.tcex.tcex_args.config_file()``, takes a JSON file as input for the App configuration file. The second method, <code class="docutils literal notranslate"><span class="pre">self.tcex.tcex_args.config()</span></code>, takes a dictionary of configuration data.  Either method will load the data and make it accessible via the <code class="docutils literal notranslate"><span class="pre">self.args</span></code> namespace.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">run()</span></code> method is the default method that is called when an App is executed. For simple Apps, the core logic of the App can be written in this method.  For more advanced Apps, additional methods can be added to the <strong>app.py</strong> file, if required.</p>
<div class="section" id="external-external">
<h3>External (external)<a class="headerlink" href="#external-external" title="Permalink to this headline">¶</a></h3>
<p>This basic template provides the structure for an External App without any logic.  This template is intended for advanced users that only require the App structure.</p>
<div class="section" id="id5">
<h4>app.py<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;ThreatConnect External App&quot;&quot;&quot;</span>

<span class="c1"># Import default External App Class (Required)</span>
<span class="kn">from</span> <span class="nn">external_app</span> <span class="kn">import</span> <span class="n">ExternalApp</span>


<span class="k">class</span> <span class="nc">App</span><span class="p">(</span><span class="n">ExternalApp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;External App&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the App main logic.</span>

<span class="sd">        This method should contain the core logic of the App.</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="external-ingress-external-ingress">
<h3>External Ingress (external_ingress)<a class="headerlink" href="#external-ingress-external-ingress" title="Permalink to this headline">¶</a></h3>
<p>This template provides a working example of how to download remote-threat intel (md5 hash Indicators) and write the data in the ThreatConnect platform using the TcEx <a class="reference internal" href="module_batch.html#module-batch"><span class="std std-ref">Batch Module</span></a>.  The URL is defined in the <code class="docutils literal notranslate"><span class="pre">init()</span></code> method for convenience. In the <code class="docutils literal notranslate"><span class="pre">run()</span></code> method, the Batch module is instantiated. Next, the data is retrieved from the remote URL and written to the Batch module. Finally, the Batch Job is submitted to ThreatConnect for processing.</p>
<div class="section" id="id6">
<h4>app.py<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;ThreatConnect Job App&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">csv</span>

<span class="c1"># Import default Job Class (Required)</span>
<span class="kn">from</span> <span class="nn">external_app</span> <span class="kn">import</span> <span class="n">ExternalApp</span>


<span class="k">class</span> <span class="nc">App</span><span class="p">(</span><span class="n">ExternalApp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;External App&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_tcex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize class properties.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">App</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_tcex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://feodotracker.abuse.ch/downloads/malware_hashes.csv&#39;</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run main App logic.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">tc_owner</span><span class="p">)</span>

        <span class="c1"># using tcex requests to get built-in features (e.g., proxy, logging, retries)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">request</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="n">decoded_content</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

                <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">decoded_content</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                    <span class="c1"># CSV headers</span>
                    <span class="c1"># Firstseen,MD5hash,Malware</span>

                    <span class="c1"># skip comments</span>
                    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="c1"># create batch entry</span>
                    <span class="n">file_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rating</span><span class="o">=</span><span class="s1">&#39;4.0&#39;</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="s1">&#39;100&#39;</span><span class="p">)</span>
                    <span class="n">file_hash</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">occurrence</span> <span class="o">=</span> <span class="n">file_hash</span><span class="o">.</span><span class="n">occurrence</span><span class="p">()</span>
                    <span class="n">occurrence</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file_hash</span><span class="p">)</span>  <span class="c1"># optionally save object to disk</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Failed to download CSV data.&#39;</span><span class="p">)</span>

        <span class="c1"># submit batch job(s)</span>
        <span class="n">batch_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">submit_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcex</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">batch_status</span><span class="p">)</span>

        <span class="c1"># self.exit_message = &#39;Downloaded and created {} file hashes.&#39;.format(</span>
        <span class="c1">#     self.batch.indicator_len</span>
        <span class="c1"># )</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>
</div>


           </div>

          </div>
          <footer>

    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">

        <a href="building_apps_tclib.html" class="btn btn-neutral float-right" title="Building Apps: Dependencies (tclib)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>


        <a href="building_apps_quickstart.html" class="btn btn-neutral float-left" title="Building Apps: Quick Start" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>

    </div>


  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, ThreatConnect Inc

    </p>
  </div>

</footer>

        </div>
      </div>

    </section>

  </div>



  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>






</body>
</html>
